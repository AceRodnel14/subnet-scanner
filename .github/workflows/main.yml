name: GitHub Actions

on:
  push:
    branches:
      - '**'

jobs:

  # ---------------------------------------------------------
  # 1. SYNC JOB — GitHub → GitLab
  # ---------------------------------------------------------
  sync_to_gitlab:
    runs-on: [self-hosted, Linux, X64]
    if: "! startsWith(github.event.head_commit.message, '[SyncWithGitLab]')"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up SSH for GitLab
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GITLAB_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          echo "${{ secrets.GITLAB_SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          git config --global user.email "${{ secrets.GITLAB_EMAIL }}"
          git config --global user.name "${{ secrets.GITLAB_USERNAME }}"
      - name: Add GitLab remote
        run: git remote add gitlab "git@gitlab.com:${{ secrets.GITLAB_REPOSITORY }}"
      - name: Rewrite commit message
        run: |
          ORIGINAL_MSG="$(git log -1 --pretty=%B)"
          git commit --amend -m "[SyncWithGitHub] $ORIGINAL_MSG" --reset-author
      - name: Push to GitLab
        run: git push gitlab "${{ github.ref_name }}" --force

  # # ---------------------------------------------------------
  # # 2. BUILD & PUSH TO GHCR
  # # ---------------------------------------------------------
  # build_ghcr:
  #   runs-on: [self-hosted, Linux, X64]
  #   needs:
  #     - sync_to_gitlab
  #   if: always()
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #     - name: Login to GHCR
  #       run: |
  #         echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
  #     - name: Build & push GHCR image
  #       run: |
  #         TAG=$(date +"%y%m%d%H%M%S")
  #         ACTOR_LC=$(echo "${{ github.actor }}" | tr '[:upper:]' '[:lower:]')
  #         docker buildx build \
  #           --platform linux/amd64,linux/arm64 \
  #           -t ghcr.io/$ACTOR_LC/subnet-scanner:$TAG \
  #           -t ghcr.io/$ACTOR_LC/subnet-scanner:latest \
  #           --push .
  #         docker logout

  # # ---------------------------------------------------------
  # # 3. BUILD & PUSH TO DOCKER HUB
  # # ---------------------------------------------------------
  # build_dockerhub:
  #   runs-on: [self-hosted, Linux, X64]
  #   needs:
  #     - sync_to_gitlab
  #     - build_ghcr
  #   if: always()
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #     - name: Login to Docker Hub
  #       run: |
  #         echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
  #     - name: Build & push Docker Hub image
  #       run: |
  #         TAG=$(date +"%y%m%d%H%M%S")
  #         docker buildx build \
  #           --platform linux/amd64,linux/arm64 \
  #           -t eacer/subnet-scanner:$TAG \
  #           --push .
  #         docker logout
  #     # - name: Build & push Docker Hub image
  #     #   run: |
  #     #     TAG=$(date +"%y%m%d%H%M%S")
  #     #     docker buildx build \
  #     #       --platform linux/amd64,linux/arm64 \
  #     #       -t eacer/subnet-scanner:$TAG \
  #     #       -t eacer/subnet-scanner:latest \
  #     #       --push .

  cleanup:
    runs-on: [self-hosted, Linux, X64]
    needs:
      - sync_to_gitlab
      # - build_ghcr
      # - build_dockerhub
    if: always()
    steps:
      - name: Cleanup workspace
        run: |
          echo "Cleaning workspace at $GITHUB_WORKSPACE"
          rm -rf "$GITHUB_WORKSPACE"
          rm -rf "$GITHUB_WORKSPACE"
          docker system prune -af --volumes
